<!-- index.html (Kullanıcı kodu + Frontend API doğrulama) -->
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Hızlı Okuma ve Alıştırmalar</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #f5f5f5;
  display: flex;
  height: 100vh;
  margin: 0;
}

/* ANA İÇERİK */
#mainContent {
  display:none;
  flex:1;
}

.left {
  flex:1;
  display:flex;
  justify-content:center;
  align-items:center;
  background:#fff;
  border-right:2px solid #ddd;
  padding:20px;
}
.left img {
  max-width:100%;
  max-height:80%;
  object-fit:contain;
}

.right {
  flex:1;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:15px;
  padding:20px;
  overflow-y:auto;
}

/* KARTLAR */
.card {
  width:80%;
  background:white;
  padding:20px;
  text-align:center;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.1);
  cursor:pointer;
  transition:transform 0.2s, box-shadow 0.2s;
}
.card:hover {
  transform:translateY(-4px);
  box-shadow:0 6px 15px rgba(0,0,0,0.2);
}
.card h2 {
  font-size:18px;
  margin:0;
  color:#333;
}

/* KULLANICI KODU OVERLAY */
#codeOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#codeBox{
  background:#ffffff;
  padding:20px 25px;
  border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.3);
  max-width:320px;
  width:90%;
  box-sizing:border-box;
}
#codeBox h2{
  margin-top:0;
  margin-bottom:10px;
  font-size:18px;
}
#codeBox input{
  width:100%;
  padding:8px;
  margin-bottom:8px;
  box-sizing:border-box;
}
#codeBox button{
  width:100%;
  padding:8px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  background:#007bff;
  color:white;
  font-size:14px;
}
#codeError{
  margin-top:6px;
  font-size:12px;
  color:#b00020;
}

/* API PANELİ */
#apiPanel{
  width:80%;
  background:#eef3ff;
  border:1px solid #c9d7ff;
  border-radius:8px;
  padding:12px;
  box-sizing:border-box;
}
#apiStatus{
  font-size:13px;
  margin-bottom:6px;
}
#apiPanel input{
  width:100%;
  padding:6px;
  margin-bottom:6px;
  box-sizing:border-box;
}
#apiPanel button{
  width:100%;
  padding:6px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  background:#007bff;
  color:white;
  font-size:14px;
}
</style>
</head>
<body>

<!-- Kullanıcı Kodu Giriş Ekranı -->
<div id="codeOverlay">
  <div id="codeBox">
    <h2>Kullanıcı Kodu Girişi</h2>
    <p style="font-size:12px;margin-top:0;margin-bottom:8px;">
      Lütfen size verilen kullanıcı kodunu girin.
    </p>
    <input type="text" id="userCodeInput" placeholder="Örn: ABC123">
    <button id="userCodeButton">Giriş Yap</button>
    <div id="codeError"></div>
  </div>
</div>

<!-- Ana içerik (başta gizli, kod doğruysa açılacak) -->
<div id="mainContent">
  <!-- Sol taraf (Logo/Resim) -->
  <div class="left">
    <img src="Logo.jpg" alt="Kronos Logo">
  </div>

  <!-- Sağ taraf (API + Egzersizler) -->
  <div class="right">

    <!-- API Paneli -->
    <div id="apiPanel">
      <!-- Başlangıçta sadece "API girilmedi" desin -->
      <div id="apiStatus">API girilmedi</div>
      <input id="apiInput" type="password" placeholder="OpenAI API anahtarı (sk-...)">
      <button onclick="checkAPI()">API Doğrula</button>
    </div>

    <div class="card" onclick="openIfAPI('goz.html')">
      <h2>Göz Egzersizi</h2>
    </div>
    <div class="card" onclick="openIfAPI('kelime.html')">
      <h2>Kelime Çalışması</h2>
    </div>
    <div class="card" onclick="openIfAPI('blok.html')">
      <h2>Blok Metin Çalışması</h2>
    </div>
    <div class="card" onclick="openIfAPI('hafiza.html')">
      <h2>Hafıza Oyunu</h2>
    </div>
  </div>
</div>

<script>
/* ========= AYARLAR ========= */
const CODE_LIST_URL = "https://ilhantopaloglu.github.io/HizliOkuma/kod.txt"; 
// txt formatı: KOD GG.AA.YYYY GG.AA.YYYY (her satır bir kod)

const USER_CODE_KEY = "USER_CODE";
const API_KEY_NAME  = "OPENAI_KEY";

const codeOverlay    = document.getElementById("codeOverlay");
const userCodeInput  = document.getElementById("userCodeInput");
const userCodeButton = document.getElementById("userCodeButton");
const codeError      = document.getElementById("codeError");
const mainContent    = document.getElementById("mainContent");

const apiStatus      = document.getElementById("apiStatus");
const apiInput       = document.getElementById("apiInput");

/* ========= SAYFA AÇILIŞ ========= */
document.addEventListener("DOMContentLoaded", () => {
  // Kullanıcı kodu kontrolü
  const storedCode = localStorage.getItem(USER_CODE_KEY);
  if (storedCode && storedCode.trim() !== "") {
    checkUserCode(storedCode);
  } else {
    codeOverlay.style.display = "flex";
  }

  // API anahtarı daha önce kaydedildiyse otomatik kontrol et
  const savedAPI = localStorage.getItem(API_KEY_NAME);
  if (savedAPI && savedAPI.trim() !== "") {
    apiInput.value = savedAPI;
    checkAPI(true); // sessiz mod: hata mesajını abartmasın
  }
});

/* ========= KULLANICI KODU KONTROLÜ ========= */
userCodeInput.addEventListener("keydown", e=>{
  if(e.key === "Enter") checkUserCode();
});
userCodeButton.addEventListener("click", () => checkUserCode());

async function checkUserCode(presetCode){
  const fromStored  = typeof presetCode === "string";
  const enteredCode = fromStored ? presetCode.trim() : userCodeInput.value.trim();
  if (!fromStored) {
    codeError.textContent = "";
  }

  if(!enteredCode){
    if (!fromStored) {
      codeError.textContent = "Lütfen bir kullanıcı kodu girin.";
    }
    return;
  }

  let listText;
  try{
    const res = await fetch(CODE_LIST_URL + "?_t=" + Date.now());
    if(!res.ok) throw new Error("kod listesi alınamadı");
    listText = await res.text();
  }catch(err){
    console.error(err);
    codeOverlay.style.display = "flex";
    if (!fromStored) {
      codeError.textContent = "Kod listesine ulaşılamadı. Lütfen daha sonra tekrar deneyin.";
    }
    return;
  }

  const lines = listText.split(/\r?\n/).map(l=>l.trim()).filter(l=>l.length>0);
  const now   = new Date();
  now.setHours(0,0,0,0);

  let foundValid = false;

  for(const line of lines){
    const parts = line.split(/\s+/);
    if(parts.length < 3) continue;

    const code   = parts[0];
    const startS = parts[1];
    const endS   = parts[2];

    if(code.toUpperCase() !== enteredCode.toUpperCase()) continue;

    const startDate = parseTRDate(startS);
    const endDate   = parseTRDate(endS);
    if(!startDate || !endDate) continue;

    if(startDate <= now && now <= endDate){
      foundValid = true;
      break;
    }
  }

  if(!foundValid){
    localStorage.removeItem(USER_CODE_KEY);
    codeOverlay.style.display = "flex";
    if (!fromStored) {
      codeError.textContent = "Kod geçersiz veya kullanım tarihi bitmiş.";
    }
    return;
  }

  localStorage.setItem(USER_CODE_KEY, enteredCode);
  codeOverlay.style.display = "none";
  mainContent.style.display = "flex";
}

function parseTRDate(str){
  const m = str.match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  const gun  = parseInt(m[1],10);
  const ay   = parseInt(m[2],10)-1;
  const yil  = parseInt(m[3],10);
  const d = new Date(yil,ay,gun);
  d.setHours(0,0,0,0);
  return isNaN(d.getTime()) ? null : d;
}

/* ========= API DOĞRULAMA (FRONTEND) ========= */
// silent=true ise ilk açılışta kayıtlı API için sessiz kontrol yapılır
async function checkAPI(silent = false){
  const key = apiInput.value.trim();
  if (!key){
    if(!silent){
      setApiStatus("API girilmedi", "red");
    }
    return;
  }

  setApiStatus("API kontrol ediliyor...", "blue");

  try{
    const res = await fetch("https://api.openai.com/v1/models", {
      headers:{
        "Authorization":"Bearer " + key
      }
    });

    if(res.ok){
      localStorage.setItem(API_KEY_NAME, key);
      setApiStatus("✅ API geçerli", "green");
    } else {
      localStorage.removeItem(API_KEY_NAME);
      setApiStatus("❌ API geçersiz", "red");
    }
  }catch(err){
    console.error(err);
    if(!silent){
      setApiStatus("⚠ Bağlantı hatası", "orange");
    } else {
      // sessiz modda ise çok bağırmasın, ama yinede bir şey yazsın
      setApiStatus("API kontrol edilemedi", "orange");
    }
  }
}

function setApiStatus(text, color){
  apiStatus.textContent = text;
  apiStatus.style.color = color;
}

/* ========= API YOKSA EGZERSİZİ AÇMA ========= */
function openIfAPI(page){
  const key = localStorage.getItem(API_KEY_NAME);
  if(!key || key.trim() === ""){
    alert("Lütfen önce geçerli bir OpenAI API anahtarı doğrulayın.");
    return;
  }
  window.location.href = page;
}
</script>

</body>
</html>
